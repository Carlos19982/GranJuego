<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Bolsa - Con Bot√≥n Men√∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos generales */
        body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .action-button { @apply px-3 py-1 text-xs font-medium text-white rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2; }
        .buy-button { @apply bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500 action-button; }
        .sell-button { @apply bg-rose-600 hover:bg-rose-700 focus:ring-rose-500 action-button; }
        .control-button { @apply px-4 py-2 font-semibold text-white rounded shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-150 ease-in-out; }
        .pause-button { @apply bg-blue-600 hover:bg-blue-700 focus:ring-blue-500 control-button; }
        .resume-button { @apply bg-red-600 hover:bg-red-700 focus:ring-red-500 control-button; }
        .history-button { @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 control-button; }
        .chart-container { height: 300px; position: relative; margin-top: 1.5rem; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .toggle-checkbox { @apply absolute block w-4 h-4 mt-1 ml-1 rounded-full bg-white border-2 appearance-none cursor-pointer; transition: right 0.2s ease-in-out; }
        .toggle-label { @apply block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer; width: 40px; transition: background-color 0.2s ease-in-out; }
        .sl-tp-label { @apply text-xs font-medium text-gray-600; }
        /* Estilos Modal Historial */
        .modal { @apply fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center; }
        .modal-content { @apply relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white; }
        .modal-close { @apply absolute top-0 right-0 cursor-pointer p-4 text-xl font-bold text-gray-700 hover:text-red-500; }
        .history-list-item { @apply border-b border-gray-200 py-3 text-sm; }
        .history-main-line span { @apply mr-2; }
        .history-gain-loss { @apply text-xs pl-4; }
        .history-type-BUY { @apply font-semibold text-green-600; }
        .history-type-SELL { @apply font-semibold text-red-600; }
        .history-type-SL { @apply font-semibold text-red-800; }
        .history-type-TP { @apply font-semibold text-green-800; }
        /* Estilo para inputs peque√±os */
        .portfolio-qty-input { @apply w-14 px-2 py-1 border border-gray-300 rounded text-sm text-center focus:ring-1 focus:ring-blue-500 focus:border-blue-500; }
         /* Estilo para el bot√≥n de men√∫ */
        .menu-link-button { @apply inline-block bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm no-underline focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500; }

    </style>
     <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="mb-8 p-4 bg-white rounded-lg shadow-md">
             <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-4">Simulador de Bolsa</h1>
             <div class="flex flex-wrap justify-around text-center text-sm md:text-base text-gray-700">
                 <div class="info-item mx-2 my-1"><span class="font-semibold">Dinero:</span> $<span id="cash">10.000,00</span></div>
                 <div class="info-item mx-2 my-1"><span class="font-semibold">Valor Cartera:</span> $<span id="portfolio-value">0,00</span></div>
                 <div class="info-item mx-2 my-1"><span class="font-semibold">Valor Total:</span> $<span id="total-value">10.000,00</span></div>
             </div>
         </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">
            <section id="market-chart-section" class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                 <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">Mercado de Acciones</h2>
                 <div class="chart-container mb-6">
                     <canvas id="stockChart"></canvas>
                 </div>
             </section>

             <section id="portfolio-section" class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                 <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4">Mi Cartera</h2>
                 <div id="portfolio" class="space-y-4">
                     <p id="empty-portfolio-msg" class="text-gray-500">A√∫n no tienes acciones.</p>
                 </div>
             </section>

             <section id="market-list-section" class="bg-white p-4 md:p-6 rounded-lg shadow-md md:col-span-2">
                 <h3 class="text-lg font-semibold text-gray-700 mb-3">Acciones Disponibles</h3>
                 <div id="stock-market" class="space-y-4">
                     <p class="text-gray-500">Cargando mercado...</p>
                 </div>
             </section>
        </main>

        <footer class="text-center space-y-4 pb-8">
             <div id="message-box" class="p-3 bg-gray-100 border border-gray-300 rounded-md text-gray-700 min-h-[40px] text-sm md:text-base">
                 ¬°Bienvenido! El mercado se actualiza cada 10 segundos. Activa SL (-4%) o TP (+5%) en tu cartera si lo deseas.
             </div>
             <div class="controls flex justify-center space-x-4">
                 <button id="pause-resume-btn" class="pause-button">Pausar</button>
                 <button id="history-btn" onclick="showHistory()" class="history-button">Mostrar Historial</button>
             </div>
             <div class="mt-4">
                 <a href="../index.html" id="exit-button" class="menu-link-button">
                     &larr; Men√∫
                 </a>
            </div>
        </footer>

        <div id="history-modal" class="modal hidden">
             <div class="modal-content">
                 <span class="modal-close" onclick="closeHistory()">&times;</span>
                 <h3 class="text-xl font-semibold mb-4 text-gray-800">Historial de Transacciones</h3>
                 <div class="max-h-96 overflow-y-auto">
                     <ul id="history-list">
                         <li class="text-gray-500">No hay transacciones todav√≠a.</li>
                     </ul>
                 </div>
             </div>
         </div>

    </div>

    <script>
        // --- Constantes de Storage (IMPORTANTE: deben coincidir con index.html) ---
        const BALANCE_LOCAL_STORAGE_KEY = 'cardGamePlayerBalance_v3';
        const GAME6_INVESTMENT_SESSION_KEY = 'game6InitialInvestment';
        const DEFAULT_BALANCE = 5000; // Saldo por defecto si no se encuentra en localStorage

        // --- Configuraci√≥n Inicial ---
        let cash = 10000; // Se sobrescribir√° con la inversi√≥n inicial
        let portfolio = {};
        const initialStockData = [
            { symbol: 'TECH', name: 'Tech Corp üíª', price: 150.00, volatility: 0.032, trend: 0.00002, color: '#3B82F6' },
            { symbol: 'FOOD', name: 'Foodies Inc üçî', price: 50.00, volatility: 0.016, trend: 0.00001, color: '#F59E0B' },
            { symbol: 'GAME', name: 'GameDev Co üéÆ', price: 80.00, volatility: 0.048, trend: -0.00001, color: '#8B5CF6' },
            { symbol: 'FIN', name: 'Finance Hub üí∞', price: 200.00, volatility: 0.024, trend: 0.000015, color: '#10B981' },
            { symbol: 'ECO', name: 'Eco Energy üåø', price: 70.00, volatility: 0.040, trend: 0.00003, color: '#6B7280' }
        ];
        let stocks = [];
        let transactionHistory = [];
        const stopLossThreshold = -4.0;
        const takeProfitThreshold = 5.0;
        let gameInterval;
        let isPaused = false;
        const updateInterval = 10000; // 10 segundos
        const maxHistoryLength = 60;
        let tickCounter = 0;
        let initialInvestment = 0; // Guardar√° la inversi√≥n inicial le√≠da de sessionStorage

        // --- Elementos del DOM ---
        const cashEl = document.getElementById('cash');
        const portfolioValueEl = document.getElementById('portfolio-value');
        const totalValueEl = document.getElementById('total-value');
        const stockMarketEl = document.getElementById('stock-market');
        const portfolioEl = document.getElementById('portfolio');
        const emptyPortfolioMsgEl = document.getElementById('empty-portfolio-msg');
        const pauseResumeBtn = document.getElementById('pause-resume-btn');
        const messageBoxEl = document.getElementById('message-box');
        const chartCanvas = document.getElementById('stockChart');
        const historyModal = document.getElementById('history-modal');
        const historyListEl = document.getElementById('history-list');
        const exitButton = document.getElementById('exit-button'); // Bot√≥n Men√∫
        let stockChart = null;

        // --- Funciones del Juego ---

        /**
         * Muestra un mensaje al usuario en el √°rea designada.
         * @param {string} msg - El mensaje a mostrar.
         * @param {string} [type='info'] - El tipo de mensaje ('info', 'success', 'error').
         */
        function showMessage(msg, type = 'info') {
            messageBoxEl.textContent = msg;
            messageBoxEl.classList.remove('bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-700', 'bg-gray-100', 'border-gray-300', 'text-gray-700');
            switch (type) {
                case 'error': messageBoxEl.classList.add('bg-red-100', 'border-red-400', 'text-red-700'); break;
                case 'success': messageBoxEl.classList.add('bg-green-100', 'border-green-400', 'text-green-700'); break;
                case 'info': default: messageBoxEl.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700'); break;
            }
        }

        /**
         * Formatea un n√∫mero como moneda espa√±ola.
         * @param {number} amount - La cantidad a formatear.
         * @returns {string} La cantidad formateada como string.
         */
        function formatCurrency(amount) {
            // Asegurarse de que es un n√∫mero antes de formatear
            if (typeof amount !== 'number' || isNaN(amount)) {
                return '0,00'; // O un valor por defecto apropiado
            }
            return amount.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        /**
         * Formatea una fecha y hora para mostrarla.
         * @param {Date} date - El objeto Date a formatear.
         * @returns {string} La fecha y hora formateada.
         */
        function formatTimestamp(date) {
            if (!(date instanceof Date)) return 'Fecha inv√°lida';
            return date.toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        /**
         * Actualiza la visualizaci√≥n del dinero disponible.
         */
        function updateGameInfo() {
            cashEl.textContent = formatCurrency(cash);
            // El valor de la cartera y total se actualizan en renderPortfolio()
        }

        /**
         * Construye la lista inicial de acciones disponibles en el mercado.
         */
        function buildStockMarketList() {
            stockMarketEl.innerHTML = '';
            if (stocks.length === 0) {
                stockMarketEl.innerHTML = '<p class="text-gray-500">No hay acciones disponibles.</p>';
                return;
            }
            stocks.forEach(stock => {
                const stockDiv = document.createElement('div');
                stockDiv.id = `stock-item-${stock.symbol}`;
                stockDiv.className = 'stock-item border border-gray-200 rounded-lg p-3 shadow-sm flex flex-wrap justify-between items-center';
                stockDiv.innerHTML = `
                    <div class="flex-grow flex items-center mb-2 md:mb-0 mr-4">
                        <div class="relative inline-block w-10 mr-3 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle-${stock.symbol}" id="toggle-${stock.symbol}" class="toggle-checkbox" ${stock.showOnChart ? 'checked' : ''} onchange="toggleChartVisibility('${stock.symbol}')"/>
                            <label for="toggle-${stock.symbol}" class="toggle-label"></label>
                        </div>
                        <div class="stock-info">
                            <div class="stock-name font-semibold text-gray-700">${stock.name} (${stock.symbol})</div>
                            <div class="stock-price text-sm text-gray-600">
                                Precio: <span id="price-value-${stock.symbol}">$${formatCurrency(stock.price)}</span>
                                <span class="price-change-indicator font-bold ml-2" id="change-indicator-${stock.symbol}"></span>
                            </div>
                        </div>
                    </div>
                    <div class="actions flex items-center space-x-2 mt-2 md:mt-0 w-full md:w-auto justify-end">
                        <input type="number" id="buy-qty-${stock.symbol}" min="1" value="1" class="portfolio-qty-input">
                        <button onclick="buyStock('${stock.symbol}')" class="buy-button">Comprar</button>
                    </div>
                `;
                stockMarketEl.appendChild(stockDiv);
                updateStockItemDisplay(stock);
            });
        }

        /**
         * Actualiza la visualizaci√≥n de un item de acci√≥n espec√≠fico.
         * @param {object} stock - El objeto de la acci√≥n a actualizar.
         */
        function updateStockItemDisplay(stock) {
            const priceValueEl = document.getElementById(`price-value-${stock.symbol}`);
            const changeIndicatorEl = document.getElementById(`change-indicator-${stock.symbol}`);
            if (!priceValueEl || !changeIndicatorEl) return;

            const priceChange = stock.price - stock.lastPrice;
            const changeIndicatorSymbol = priceChange > 0 ? '‚ñ≤' : (priceChange < 0 ? '‚ñº' : '');
            const changeClass = priceChange > 0 ? 'price-up' : (priceChange < 0 ? 'price-down' : 'text-gray-500');

            priceValueEl.textContent = `$${formatCurrency(stock.price)}`;
            changeIndicatorEl.textContent = `${changeIndicatorSymbol} ${formatCurrency(Math.abs(priceChange))}`;
            changeIndicatorEl.className = `price-change-indicator font-bold ml-2 ${changeClass}`;
        }

        /**
         * Actualiza la visualizaci√≥n de todas las acciones en el mercado.
         */
        function renderStockMarket() {
            stocks.forEach(stock => {
                if (document.getElementById(`stock-item-${stock.symbol}`)) {
                    updateStockItemDisplay(stock);
                }
            });
        }

        /**
         * Calcula el valor actual total de la cartera.
         * @returns {number} El valor total de las acciones en cartera.
         */
        function calculatePortfolioValue() {
            let currentPortfolioValue = 0;
            const portfolioSymbols = Object.keys(portfolio);

            portfolioSymbols.forEach(symbol => {
                const stock = stocks.find(s => s.symbol === symbol);
                const portfolioItem = portfolio[symbol];
                if (stock && portfolioItem && portfolioItem.quantity > 0) {
                    currentPortfolioValue += portfolioItem.quantity * stock.price;
                }
            });
            return currentPortfolioValue;
        }


        /**
         * Renderiza la secci√≥n de la cartera del usuario y actualiza los valores globales.
         */
        function renderPortfolio() {
            portfolioEl.innerHTML = '';
            const portfolioSymbols = Object.keys(portfolio);
            let currentPortfolioValue = 0; // Recalcular aqu√≠ para la visualizaci√≥n

            if (portfolioSymbols.length === 0) {
                portfolioEl.appendChild(emptyPortfolioMsgEl);
                emptyPortfolioMsgEl.style.display = 'block';
            } else {
                emptyPortfolioMsgEl.style.display = 'none';
                portfolioSymbols.forEach(symbol => {
                    const stock = stocks.find(s => s.symbol === symbol);
                    const portfolioItem = portfolio[symbol];

                    if (!stock || !portfolioItem || portfolioItem.quantity <= 0) {
                        if (portfolio[symbol]) delete portfolio[symbol];
                        return;
                    };

                    const marketValue = portfolioItem.quantity * stock.price;
                    const costBasis = portfolioItem.quantity * portfolioItem.avgPrice;
                    const gainLoss = marketValue - costBasis;
                    const gainLossPercent = portfolioItem.avgPrice !== 0 ? (gainLoss / costBasis) * 100 : 0;
                    const gainLossClass = gainLoss >= 0 ? 'price-up' : 'price-down';

                    currentPortfolioValue += marketValue; // Sumar al valor total para visualizaci√≥n

                    const portfolioDiv = document.createElement('div');
                    portfolioDiv.className = 'portfolio-item border border-gray-200 rounded-lg p-3 shadow-sm';
                    portfolioDiv.innerHTML = `
                        <div class="portfolio-info mb-3">
                            <div class="portfolio-name font-semibold text-gray-700">${stock.name} (${symbol})</div>
                            <div class="portfolio-details text-sm text-gray-600 space-y-1 mt-1">
                                <div>Cantidad: ${portfolioItem.quantity}</div>
                                <div>Precio Prom.: $${formatCurrency(portfolioItem.avgPrice)}</div>
                                <div>Precio Actual: $${formatCurrency(stock.price)}</div>
                                <div>Valor Mercado: $${formatCurrency(marketValue)}</div>
                            </div>
                            <div class="portfolio-gainloss text-sm mt-2 ${gainLossClass}">
                                <span class="font-semibold">G/P:</span> $${formatCurrency(gainLoss)} (${formatCurrency(gainLossPercent)}%)
                            </div>
                        </div>
                        <div class="sl-tp-controls border-t border-gray-200 pt-3 mt-3 flex items-center justify-start space-x-6">
                            <div class="flex items-center space-x-2">
                                <label for="sl-toggle-${symbol}" class="sl-tp-label">SL (${stopLossThreshold}%)</label>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="sl-toggle-${symbol}" id="sl-toggle-${symbol}" class="toggle-checkbox" ${portfolioItem.slActive ? 'checked' : ''} onchange="toggleStopLoss('${symbol}')"/>
                                    <label for="sl-toggle-${symbol}" class="toggle-label"></label>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="tp-toggle-${symbol}" class="sl-tp-label">TP (+${takeProfitThreshold}%)</label>
                                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="tp-toggle-${symbol}" id="tp-toggle-${symbol}" class="toggle-checkbox" ${portfolioItem.tpActive ? 'checked' : ''} onchange="toggleTakeProfit('${symbol}')"/>
                                    <label for="tp-toggle-${symbol}" class="toggle-label"></label>
                                </div>
                            </div>
                        </div>
                        <div class="manual-sell-controls border-t border-gray-200 pt-3 mt-3 flex items-center justify-start space-x-2">
                             <label for="sell-portfolio-qty-${symbol}" class="text-sm font-medium text-gray-700">Vender:</label>
                             <input type="number" id="sell-portfolio-qty-${symbol}" min="1" value="1" class="portfolio-qty-input">
                             <button onclick="sellFromPortfolio('${symbol}')" class="sell-button">Vender</button>
                        </div>
                    `;
                    portfolioEl.appendChild(portfolioDiv);
                });
            }

            // Actualizar valores globales en la cabecera
            portfolioValueEl.textContent = formatCurrency(currentPortfolioValue);
            totalValueEl.textContent = formatCurrency(cash + currentPortfolioValue);
        }

        /**
         * Compra una cantidad espec√≠fica de una acci√≥n.
         * @param {string} symbol - El s√≠mbolo de la acci√≥n a comprar.
         */
        function buyStock(symbol) {
            if (isPaused) { showMessage('El mercado est√° pausado. Reanuda para operar.', 'error'); return; }
            const quantityInput = document.getElementById(`buy-qty-${symbol}`);
            const quantity = parseInt(quantityInput.value);
            const stock = stocks.find(s => s.symbol === symbol);

            if (!stock || isNaN(quantity) || quantity <= 0) { showMessage('Cantidad inv√°lida.', 'error'); quantityInput.focus(); return; }
            const cost = stock.price * quantity;
            if (cost > cash) { showMessage('No tienes suficiente dinero.', 'error'); return; }

            const buyPrice = stock.price;
            cash -= cost;

            if (portfolio[symbol]) {
                const existingQuantity = portfolio[symbol].quantity;
                const existingAvgPrice = portfolio[symbol].avgPrice;
                portfolio[symbol].avgPrice = ((existingAvgPrice * existingQuantity) + cost) / (existingQuantity + quantity);
                portfolio[symbol].quantity += quantity;
            } else {
                portfolio[symbol] = { quantity: quantity, avgPrice: buyPrice, slActive: false, tpActive: false };
            }

            addTransaction('BUY', symbol, quantity, buyPrice);
            showMessage(`Compraste ${quantity} acciones de ${symbol} por $${formatCurrency(cost)}`, 'success');
            quantityInput.value = '1';
            updateGameInfo();
            renderPortfolio();
            // No guardamos estado aqu√≠, solo al salir
        }

        /**
         * Inicia la venta manual desde la secci√≥n de cartera.
         * @param {string} symbol - El s√≠mbolo de la acci√≥n a vender.
         */
         function sellFromPortfolio(symbol) {
             if (isPaused) { showMessage('El mercado est√° pausado. Reanuda para operar.', 'error'); return; }
             const inputId = `sell-portfolio-qty-${symbol}`;
             const quantityInput = document.getElementById(inputId);
             if (!quantityInput) { console.error(`Input not found: ${inputId}`); return; }
             const quantity = parseInt(quantityInput.value);
             const success = sellStock(symbol, quantity, false, '');
             if (success || (!success && quantity > 0)) { quantityInput.value = '1'; }
         }

        /**
         * Vende una cantidad espec√≠fica de una acci√≥n.
         * @param {string} symbol - El s√≠mbolo de la acci√≥n a vender.
         * @param {number} quantityToSell - La cantidad a vender.
         * @param {boolean} [isAutoSell=false] - Indica si es una venta autom√°tica (SL/TP).
         * @param {string} [triggerType=''] - El tipo de trigger si es autom√°tica ('SL' o 'TP').
         * @returns {boolean} True si la venta fue exitosa, False en caso contrario.
         */
        function sellStock(symbol, quantityToSell = 0, isAutoSell = false, triggerType = '') {
            if (!isAutoSell && isPaused) { showMessage('El mercado est√° pausado. Reanuda para operar.', 'error'); return false; }
            const stock = stocks.find(s => s.symbol === symbol);
            const quantity = quantityToSell;

            if (!stock || isNaN(quantity) || quantity <= 0) { if (!isAutoSell) showMessage('Cantidad inv√°lida.', 'error'); return false; }
            if (!portfolio[symbol] || portfolio[symbol].quantity < quantity) { if (!isAutoSell) showMessage(`No tienes suficientes acciones de ${symbol} para vender.`, 'error'); return false; }

            const sellPrice = stock.price;
            const avgPrice = portfolio[symbol].avgPrice;
            const revenue = sellPrice * quantity;
            cash += revenue;

            const soldQuantity = quantity;
            portfolio[symbol].quantity -= quantity;

            let transactionType = 'SELL';
            let messageType = 'success';
            if (isAutoSell) {
                transactionType = triggerType;
                messageType = triggerType === 'SL' ? 'error' : 'success';
            }

            addTransaction(transactionType, symbol, soldQuantity, sellPrice, avgPrice);

            if (portfolio[symbol].quantity === 0) { delete portfolio[symbol]; }

            if (isAutoSell) {
                if (triggerType === 'SL') showMessage(`¬°STOP-LOSS (${stopLossThreshold}%) ACTIVADO! Vendidas ${soldQuantity} acciones de ${symbol} a $${formatCurrency(sellPrice)}.`, messageType);
                else if (triggerType === 'TP') showMessage(`¬°TAKE-PROFIT (+${takeProfitThreshold}%) ACTIVADO! Vendidas ${soldQuantity} acciones de ${symbol} a $${formatCurrency(sellPrice)}.`, messageType);
                else showMessage(`¬°Venta Autom√°tica! Vendidas ${soldQuantity} acciones de ${symbol} a $${formatCurrency(sellPrice)}.`, 'info');
            } else { showMessage(`Vendiste ${soldQuantity} acciones de ${symbol} por $${formatCurrency(revenue)}`, messageType); }

            updateGameInfo();
            renderPortfolio();
            // No guardamos estado aqu√≠, solo al salir
            return true;
        }

        /**
         * A√±ade una transacci√≥n al historial.
         */
        function addTransaction(type, symbol, quantity, price, avgPrice = null) {
            const transaction = { type: type, symbol: symbol, quantity: quantity, price: price, timestamp: new Date(), avgPrice: avgPrice };
            transactionHistory.push(transaction);
        }

        /**
         * Activa/desactiva el Stop-Loss.
         */
        function toggleStopLoss(symbol) {
            if (isPaused) { showMessage('El mercado est√° pausado. Reanuda para operar.', 'error'); const cb = document.getElementById(`sl-toggle-${symbol}`); if(cb) cb.checked = !cb.checked; return; }
            if (portfolio[symbol]) { portfolio[symbol].slActive = !portfolio[symbol].slActive; showMessage(`Stop-Loss (${stopLossThreshold}%) para ${symbol} ${portfolio[symbol].slActive ? 'ACTIVADO' : 'DESACTIVADO'}.`, 'info'); }
        }

        /**
         * Activa/desactiva el Take-Profit.
         */
        function toggleTakeProfit(symbol) {
             if (isPaused) { showMessage('El mercado est√° pausado. Reanuda para operar.', 'error'); const cb = document.getElementById(`tp-toggle-${symbol}`); if(cb) cb.checked = !cb.checked; return; }
            if (portfolio[symbol]) { portfolio[symbol].tpActive = !portfolio[symbol].tpActive; showMessage(`Take-Profit (+${takeProfitThreshold}%) para ${symbol} ${portfolio[symbol].tpActive ? 'ACTIVADO' : 'DESACTIVADO'}.`, 'info'); }
        }

        /**
         * Revisa si alguna orden autom√°tica (SL/TP) debe ejecutarse.
         */
        function checkAutoOrders() {
            const ordersToExecute = [];
            for (const symbol in portfolio) {
                const portfolioItem = portfolio[symbol];
                const stock = stocks.find(s => s.symbol === symbol);
                if (!stock || portfolioItem.quantity <= 0 || portfolioItem.avgPrice <= 0) continue;

                const currentPrice = stock.price;
                const avgPrice = portfolioItem.avgPrice;
                const gainLossPercent = ((currentPrice - avgPrice) / avgPrice) * 100;

                if (portfolioItem.slActive && gainLossPercent <= stopLossThreshold) { ordersToExecute.push({ symbol: symbol, type: 'SL' }); continue; }
                if (portfolioItem.tpActive && gainLossPercent >= takeProfitThreshold) { ordersToExecute.push({ symbol: symbol, type: 'TP' }); }
            }
            ordersToExecute.forEach(order => { if (portfolio[order.symbol]) { const quantityToSell = portfolio[order.symbol].quantity; sellStock(order.symbol, quantityToSell, true, order.type); } });
        }

        /**
         * Simula el cambio de precio de las acciones.
         */
        function simulatePriceChange() {
            tickCounter++;
            stocks.forEach(stock => {
                stock.lastPrice = stock.price;
                const randomFactor = (Math.random() - 0.5) * 2;
                const priceChangePercent = randomFactor * stock.volatility + stock.trend;
                let newPrice = stock.price * (1 + priceChangePercent);
                newPrice = Math.max(0.01, newPrice);
                stock.price = newPrice;
                stock.history.push({ tick: tickCounter, price: stock.price });
                if (stock.history.length > maxHistoryLength) { stock.history.shift(); }
            });
        }

        /**
         * Inicializa el gr√°fico de Chart.js.
         */
        function initializeChart() {
            const ctx = chartCanvas.getContext('2d');
            stockChart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: false, ticks: { callback: value => '$' + formatCurrency(value) } }, x: { ticks: { display: false }, grid: { display: false } } },
                    plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false, callbacks: { label: context => `${context.dataset.label || ''}: $${formatCurrency(context.parsed.y)}` } } },
                    animation: { duration: 200 }
                }
            });
            updateChart();
        }

        /**
         * Actualiza los datos y la visualizaci√≥n del gr√°fico.
         */
        function updateChart() {
             if (!stockChart) return;
             const visibleStocks = stocks.filter(stock => stock.showOnChart);
             let labels = [];
             if (visibleStocks.length > 0 && visibleStocks[0].history.length > 0) { labels = visibleStocks[0].history.map(h => h.tick); }
             else if (tickCounter > 0) { const startTick = Math.max(1, tickCounter - maxHistoryLength + 1); for (let i = startTick; i <= tickCounter; i++) labels.push(i); }
             if (labels.length > maxHistoryLength) labels.splice(0, labels.length - maxHistoryLength);
             stockChart.data.labels = labels;
             stockChart.data.datasets = visibleStocks.map(stock => {
                 const historyData = stock.history.slice(-labels.length).map(h => h.price);
                 while (historyData.length < labels.length) historyData.unshift(null);
                 return { label: stock.symbol, data: historyData, borderColor: stock.color, backgroundColor: stock.color + '33', tension: 0.1, pointRadius: 0, pointHoverRadius: 5 };
             });
             stockChart.update();
         }

        /**
         * Cambia la visibilidad de una acci√≥n en el gr√°fico.
         */
        function toggleChartVisibility(symbol) {
            const stock = stocks.find(s => s.symbol === symbol);
            if (stock) { stock.showOnChart = !stock.showOnChart; updateChart(); }
        }

        /**
         * Actualiza el estado del mercado peri√≥dicamente.
         */
        function updateMarket() {
            if (isPaused) return;
            simulatePriceChange();
            renderStockMarket();
            renderPortfolio(); // Esto actualiza los valores globales visualmente
            checkAutoOrders();
            updateChart();
        }

        /**
         * Pausa o reanuda la simulaci√≥n del mercado.
         */
        function togglePause() {
             isPaused = !isPaused;
             if (isPaused) {
                 clearInterval(gameInterval);
                 pauseResumeBtn.textContent = 'Reanudar';
                 pauseResumeBtn.classList.remove('pause-button', 'bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
                 pauseResumeBtn.classList.add('resume-button', 'bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
                 showMessage('Mercado pausado.', 'info');
             } else {
                 updateMarket(); // Actualizar inmediatamente al reanudar
                 gameInterval = setInterval(updateMarket, updateInterval);
                 pauseResumeBtn.textContent = 'Pausar';
                 pauseResumeBtn.classList.remove('resume-button', 'bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500');
                 pauseResumeBtn.classList.add('pause-button', 'bg-blue-600', 'hover:bg-blue-700', 'focus:ring-blue-500');
                 showMessage('Mercado reanudado.', 'info');
             }
         }

        /**
         * Muestra el modal con el historial de transacciones.
         */
        function showHistory() {
             historyListEl.innerHTML = '';
             if (transactionHistory.length === 0) {
                 historyListEl.innerHTML = '<li class="text-gray-500">No hay transacciones todav√≠a.</li>';
             } else {
                 [...transactionHistory].reverse().forEach(tx => {
                     const li = document.createElement('li');
                     li.className = 'history-list-item';
                     const timestamp = typeof tx.timestamp === 'string' ? new Date(tx.timestamp) : tx.timestamp;
                     const stockInfo = stocks.find(s => s.symbol === tx.symbol);
                     const stockName = stockInfo ? stockInfo.name : tx.symbol;
                     let gainLossHTML = '';
                     if (['SELL', 'SL', 'TP'].includes(tx.type) && tx.avgPrice !== null && tx.avgPrice > 0) {
                         const realizedGainLoss = (tx.price - tx.avgPrice) * tx.quantity;
                         const gainLossClass = realizedGainLoss >= 0 ? 'price-up' : 'price-down';
                         gainLossHTML = `<div class="history-gain-loss ${gainLossClass}">Ganancia/P√©rdida: $${formatCurrency(realizedGainLoss)}</div>`;
                     }
                     li.innerHTML = `
                         <div class="history-main-line">
                             <span class="history-type-${tx.type}">${tx.type}</span>
                             <span>${stockName}:</span>
                             <span>${tx.quantity} acc.</span>
                             <span>@ $${formatCurrency(tx.price)}</span>
                             <span class="text-gray-500 text-xs float-right">${formatTimestamp(timestamp)}</span>
                         </div>
                         ${gainLossHTML}
                     `;
                     historyListEl.appendChild(li);
                 });
             }
             historyModal.classList.remove('hidden');
         }

        /**
         * Cierra el modal del historial.
         */
        function closeHistory() {
            historyModal.classList.add('hidden');
        }

        /**
         * Obtiene el saldo global actual desde localStorage.
         * @returns {number} El saldo global actual o el valor por defecto.
         */
        function getCurrentGlobalBalance() {
            try {
                const savedBalance = localStorage.getItem(BALANCE_LOCAL_STORAGE_KEY);
                if (savedBalance !== null) {
                    const parsedBalance = parseInt(savedBalance);
                    if (!isNaN(parsedBalance)) {
                        return parsedBalance;
                    }
                }
            } catch (error) {
                console.error("Error al leer el saldo global desde localStorage:", error);
            }
            return DEFAULT_BALANCE; // Retorna el saldo por defecto si hay error o no existe
        }

        /**
         * Guarda el nuevo saldo global en localStorage.
         * @param {number} newBalance - El nuevo saldo a guardar.
         */
        function saveGlobalBalance(newBalance) {
             try {
                 // Asegurarse de guardar un n√∫mero entero
                 const balanceToSave = Math.round(newBalance);
                 if (isNaN(balanceToSave)) {
                     console.error("Intento de guardar un saldo global inv√°lido (NaN).");
                     return;
                 }
                 localStorage.setItem(BALANCE_LOCAL_STORAGE_KEY, balanceToSave.toString());
                 console.log(`Nuevo saldo global guardado: ${balanceToSave}`);
             } catch (error) {
                 console.error("Error al guardar el saldo global en localStorage:", error);
                 showMessage("Error al actualizar el saldo global.", "error");
             }
         }

        /**
         * Carga el estado inicial del juego (inversi√≥n) y configura las acciones.
         */
        function loadGameState() {
             try {
                 const initialInvestmentStr = sessionStorage.getItem(GAME6_INVESTMENT_SESSION_KEY);
                 let parsedInvestment = 10000; // Default investment if not found or invalid

                 if (initialInvestmentStr) {
                     const tempInvestment = parseInt(initialInvestmentStr);
                     if (!isNaN(tempInvestment) && tempInvestment > 0) {
                         parsedInvestment = tempInvestment;
                     } else {
                         console.warn("Inversi√≥n inicial inv√°lida en sessionStorage. Usando 10,000 por defecto.");
                     }
                 } else {
                     console.warn("No se encontr√≥ inversi√≥n inicial en sessionStorage. Usando 10,000 por defecto.");
                 }
                 initialInvestment = parsedInvestment; // Guardar para c√°lculos al salir
                 cash = initialInvestment; // Establecer el dinero inicial del juego

             } catch (error) {
                 console.error("Error al leer la inversi√≥n inicial de sessionStorage:", error);
                 initialInvestment = 10000; // Usar valor por defecto en caso de error
                 cash = initialInvestment;
             }

             // Limpiar estado previo de localStorage (si existiera, aunque no se usa para cargar)
             localStorage.removeItem('stockGameState'); // Nombre de clave anterior, mantener por si acaso
             console.log("Estado de juego previo (si exist√≠a) limpiado. Empezando con inversi√≥n.");

             // Inicializar acciones
             stocks = initialStockData.map(initialStock => ({
                 ...initialStock,
                 lastPrice: initialStock.price,
                 history: [{ tick: 0, price: initialStock.price }],
                 showOnChart: initialStock.showOnChart !== undefined ? initialStock.showOnChart : true
             }));

             transactionHistory = [];
             portfolio = {};

             showMessage(`Inversi√≥n inicial: $${formatCurrency(cash)}. ¬°Bienvenido! El mercado se actualiza cada 10 segundos.`, "info");
         }


        /**
         * Inicializa todos los componentes del juego al cargar la p√°gina.
         */
        function initializeGame() {
            loadGameState(); // Carga la inversi√≥n inicial y resetea estado
            buildStockMarketList();
            renderPortfolio(); // Muestra cartera (vac√≠a) y actualiza valores iniciales
            updateGameInfo(); // Asegura que el 'cash' inicial se muestre
            initializeChart();
            gameInterval = setInterval(updateMarket, updateInterval);
        }

        /**
         * Maneja el clic en el bot√≥n "Men√∫" para actualizar el saldo global y redirigir.
         * @param {Event} event - El evento de clic.
         */
        function handleExitClick(event) {
            event.preventDefault(); // Evitar la navegaci√≥n inmediata

            console.log("Bot√≥n Men√∫ presionado. Actualizando saldo global...");

            try {
                // 1. Calcular valor final en el simulador
                const finalPortfolioValue = calculatePortfolioValue();
                const finalTotalValue = cash + finalPortfolioValue;

                // 2. Calcular ganancia/p√©rdida neta
                const netGainLoss = finalTotalValue - initialInvestment;
                console.log(`Inversi√≥n Inicial: ${formatCurrency(initialInvestment)}`);
                console.log(`Valor Total Final: ${formatCurrency(finalTotalValue)} (Cash: ${formatCurrency(cash)}, Cartera: ${formatCurrency(finalPortfolioValue)})`);
                console.log(`Ganancia/P√©rdida Neta: ${formatCurrency(netGainLoss)}`);

                // 3. Obtener saldo global actual
                const currentGlobalBalance = getCurrentGlobalBalance();
                console.log(`Saldo Global Actual: ${formatCurrency(currentGlobalBalance)}`);

                // 4. Calcular nuevo saldo global
                const newGlobalBalance = currentGlobalBalance + netGainLoss;
                console.log(`Nuevo Saldo Global Calculado: ${formatCurrency(newGlobalBalance)}`);

                // 5. Guardar nuevo saldo global
                saveGlobalBalance(newGlobalBalance);

                // 6. Limpiar sessionStorage para la pr√≥xima vez
                sessionStorage.removeItem(GAME6_INVESTMENT_SESSION_KEY);
                console.log("Clave de inversi√≥n inicial eliminada de sessionStorage.");

            } catch (error) {
                console.error("Error durante el proceso de actualizaci√≥n del saldo al salir:", error);
                showMessage("Ocurri√≥ un error al actualizar tu saldo global. Los cambios podr√≠an no guardarse.", "error");
                // Considerar si redirigir igualmente o no
            }

            // 7. Redirigir al men√∫ principal
            console.log("Redirigiendo a:", event.target.href);
            window.location.href = event.target.href;
        }


        // --- Event Listeners ---
        pauseResumeBtn.addEventListener('click', togglePause);
        historyModal.addEventListener('click', (event) => { if (event.target === historyModal) { closeHistory(); } });
        exitButton.addEventListener('click', handleExitClick); // A√±adido listener para el bot√≥n Men√∫

        // Iniciar el juego cuando la ventana se haya cargado completamente
        window.onload = initializeGame;

        // No guardar estado al salir con beforeunload, se hace al pulsar Men√∫
        // window.addEventListener('beforeunload', saveGameState);

    </script>
</body>
</html>
